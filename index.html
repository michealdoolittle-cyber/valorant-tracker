<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAL Tracker</title>
  <style>
/* ===========================
   ROOT + GLOBAL
=========================== */
:root {
  --bg: #071029;
  --card: #0b1220;
  --muted: #94a3b8;
  --accent: #ff4655;
  --good: #16a34a;
  --bad: #ef4444;
  --seg-bg: #0f1724;

  --duelist: #ff4655;
  --controller: #7b3fbf;
  --initiator: #3b82f6;
  --sentinel: #22c55e;
}

* {
  box-sizing: border-box;
}
html, body {
  height: 100%;
  margin: 0;
}
.app {
  display: flex;
  flex-direction: column;
  min-height: 100%;
}
.app-header {
  flex: 0 0 88px; /* fixed header height */
}
#page-home {
  flex: 1; /* fill rest of space */
  display: flex;
  flex-direction: column;
}
.home-layout {
  flex-grow: 1; /* allow content area to grow/shrink, avoid overflow */
  overflow: hidden;
}

/* ===========================
   NAV + HEADER
=========================== */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  height: 88px;
  padding: 0 22px;
  background: var(--card);
  position: fixed;
  top: 0;
  left: 0;
  z-index: 999;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.nav-left {
  display: flex;
  align-items: center;
  gap: 28px;
  justify-content: flex-start;  /* Align to the left */
}

.nav-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-img {
  height: 26px;
  width: 26px;
  opacity: 0.9;
}

.logo-text {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 1px;
}

.nav-links {
  position: relative;
  display: flex;
  gap: 14px;
}

.nav-btn {
  background: transparent;
  border: none;
  color: #c9d6e4;
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  transition: 0.15s;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.nav-btn:hover {
  background: rgba(255,255,255,0.08);
}

.nav-btn.active {
  background: var(--accent);
  color: white;
}

.nav-underline {
  position: absolute;
  bottom: -3px;
  height: 3px;
  background: var(--accent);
  border-radius: 2px;
  width: 0;
  left: 0;
  transition: 0.25s cubic-bezier(.25,.8,.25,1);
}
/* RR Progress Bars */
.nav-right {
  display: flex;
  justify-content: flex-end;  /* Align to the right */
  align-items: center;
  gap: 20px;
  position: relative;
  z-index: 50;
}

/* Profile Panel should be inside nav-right */
@media (max-width: 920px) {
  .profile-panel {
    position: fixed;  /* Ensure the profile panel remains fixed in place */
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    z-index: 100;
  }
}


.profile-avatar-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2px;
  border-radius: 50%;
  transition: 0.2s ease;
  cursor: pointer;
}

.profile-avatar-ring {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: 2px solid #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.2s;
}

.profile-avatar-wrap:hover .profile-avatar-ring {
  border-color: var(--accent);
  box-shadow: 0 0 12px rgba(255,70,85,0.55); /* Optional shadow on hover */
  background-color: rgba(255, 255, 255, 0.1); /* Optional background color change */
}

.profile-avatar-img {
  width: 36px;
  height: 36px;
  border-radius: 999px;
  object-fit: cover;
}

.profile-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 14px;  /* Increase font size for better readability */
}

.profile-region {
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.5);
  color: #38bdf8;
}

.profile-divider {
  width: 1px;
  height: 50px;
  background: rgba(255,255,255,0.25);
  margin: 0 6px;
}

.profile-dropdown-toggle {
  pointer-events: auto;
  transition: transform 0.18s ease;
}

.profile-panel.open .profile-dropdown-toggle {
  transform: rotate(180deg);  /* Rotate the dropdown icon when the panel is open */
}

/* Settings Dropdown */
.profile-dropdown {
  position: absolute;
  top: calc(88px + 6px);
  right: 22px;
  width: 260px;
  background: rgba(15,23,42,0.98);
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.5);
  box-shadow: 0 18px 40px rgba(0,0,0,0.7);
  padding: 8px 0;
  z-index: 1200;
  opacity: 0;
  visibility: hidden;
  transform: scale(0.92);
  transition: 0.18s ease-out;
}

.profile-dropdown.open {
  opacity: 1;
  visibility: visible;
  transform: scale(1);
}

.pd-section-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  padding: 10px 14px 4px;
  text-transform: uppercase;
  margin-bottom: 4px;
  color: var(--accent);
}

/* Hamburger Button (Mobile) */
.hamburger {
  display: none;  /* Hide by default */
  background: transparent;
  border: none;
  font-size: 28px;
  color: #e6eef8;
  cursor: pointer;
}
/* ===========================
   PAGE BASE
=========================== */
.page {
  display: none;
  padding-top: 100px;
  min-height: calc(100vh - 88px);
}

.page.active {
  display: block;
}
.page {
  overflow: auto;
}

/* ===========================
   HOME LAYOUT
=========================== */
#page-home {
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 88px);
  justify-content: flex-start;
  align-items: center;
  width: 100%;
}

.home-layout {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3-column layout for larger screens */
  grid-template-rows: auto auto 1fr auto auto;
  grid-template-areas:
    "weekly-focus weekly-focus improvement-line"
    "lens-compass round-impact round-impact"
    "loadout-generator rr-calculator rr-calculator"
    "rr-trend-chart rr-trend-chart rr-trend-chart";
  gap: 16px;
  width: 100%;
  max-width: 1200px;
  padding: 16px;
  margin: 0 auto;
}

@media (max-width: 920px) {
  .home-layout {
    grid-template-columns: 1fr; /* Stack into one column for mobile */
    gap: 12px; /* Adjust gap for better mobile spacing */
  }
}


/* ===========================
   CARD STYLES
=========================== */
.card {
  padding: 16px;
  gap: 16px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.weekly-focus-card {
  grid-area: weekly-focus;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 16px;
}

.improvement-timeline {
  grid-area: improvement-line;
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid rgba(148,163,184,0.35);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chart-compass-layout {
  grid-area: lens-compass;
  display: flex;
  gap: 16px;
  width: 100%;
}

.impact-card {
  grid-area: round-impact;
}

.loadout-card {
  grid-area: loadout-generator;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 16px;
}

.rr-card {
  grid-area: rr-calculator;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 16px;
}

.rr-chart-card {
  grid-area: rr-trend-chart;
}
/* ===========================
   BUTTONS
=========================== */
button {
  appearance: none;
  border: none;
  cursor: pointer;
  background: #1e293b;
  color: #e2e8f0;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  transition: background 0.22s, transform 0.15s;
  width: auto; /* Ensure buttons take up full width when needed */
}

input[type="number"],
input[type="text"],
select,
textarea {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: transparent;
  color: #e6eef8;
}

textarea {
  min-height: 64px;
  resize: vertical;
}

button:hover {
  background: #334155;
  transform: translateY(-2px);
}

button:active {
  transform: scale(0.96);
}

button.rr-btn {
  padding: 8px 12px !important;
}

button.rr-btn.btn-win {
  background: var(--good) !important;
}

button.rr-btn.btn-loss {
  background: var(--bad) !important;
}

button.rr-btn.btn-draw {
  background: #3b82f6 !important;
}

button.rr-btn.btn-undo {
  background: #222 !important;
}
/* ===========================
   MATCH LIST
=========================== */
#matchList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#matchList li {
  padding: 10px;
  background: rgba(255, 255, 255, 0.04);
  margin-bottom: 6px;
  border-radius: 8px;
  transition: 0.15s;
}

#matchList li:hover {
  background: rgba(255, 70, 85, 0.25);
}

.match-delete-btn {
  background: transparent;
  border: none;
  color: #ff4655;
  padding: 4px 6px;
}

/* ===========================
   MODAL
=========================== */
.rr-modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 500px;
  min-width: 300px;
}

@media (max-width: 920px) {
  .rr-modal-content {
    width: 90%; /* Adjust width on smaller screens */
  }
}

#chartRow svg {
  width: 100% !important;
  height: 100% !important;
}

.close-btn {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  position: absolute;
  top: 10px;
  right: 10px;
  cursor: pointer;
}

/* ===========================
   PROFILE PANEL / AVATAR
=========================== */
.profile-panel {
  position: fixed;
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
  z-index: 100;
  display: flex;
  align-items: center;
}

.profile-avatar-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2px;
  border-radius: 50%;
  transition: 0.2s ease;
  cursor: pointer;
}

.profile-avatar-ring {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: 2px solid #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.2s;
}

.profile-avatar-wrap:hover .profile-avatar-ring {
  border-color: var(--accent);
  box-shadow: 0 0 12px rgba(255,70,85,0.55);
  background-color: rgba(255, 255, 255, 0.1);
}

.profile-avatar-img {
  width: 36px;
  height: 36px;
  border-radius: 999px;
  object-fit: cover;
}

.profile-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 12px;
  color: #e6eef8;
}

.profile-region {
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.5);
  color: #38bdf8;
}

.profile-divider {
  width: 1px;
  height: 50px;
  background: rgba(255,255,255,0.25);
  margin: 0 6px;
}


</style>
</head>
<body>
<header class="app-header">
  <div class="nav-left">
    <div class="nav-logo">
      <img src="./baseline-app_files/val-logo.png" alt="VAL" class="logo-img">
      <span class="logo-text">VAL TRACKER</span>
    </div>
    <nav class="nav-links">
      <button class="nav-btn active" data-page="home">Home</button>
      <button class="nav-btn" data-page="logging">Logging</button>
      <button class="nav-btn" data-page="insights">Insights</button>
      <button class="nav-btn" data-page="stats">Stats</button>
      <div class="nav-underline" style="width: 69.25px; left: 0px;"></div>
    </nav>
  </div>

  <div class="nav-right">
    <!-- RR Progress Bar Widgets -->
    <div class="nav-rr-progress-bar" id="nextRankWidget">
      <span class="nav-rr-label">RR to next rank</span>
      <div class="nav-rr-value">+120 → Ascendant 1</div>
      <div class="nav-rr-bar">
        <div class="nav-rr-fill" style="width: 65%;"></div>
      </div>
    </div>

    <div class="nav-rr-progress-bar" id="goalRankWidget">
      <span class="nav-rr-label">RR to Goal Rank</span>
      <div class="nav-rr-value">+350 → Radiant</div>
      <div class="nav-rr-bar">
        <div class="nav-rr-fill" style="width: 40%;"></div>
      </div>
    </div>

    <!-- Profile Panel should be inside nav-right -->
    <div class="profile-panel" id="profilePanel">
      <!-- Profile Avatar -->
      <div class="profile-avatar-wrap" id="profileAvatarWrap">
        <div class="profile-avatar-ring">
          <img id="profileAvatarImg" class="profile-avatar-img" src="./baseline-app_files/jett.png" alt="Avatar">
        </div>
      </div>

      <div class="profile-divider"></div>

      <div class="profile-info">
        <div class="profile-line-main">
          <span id="profileRiotId">RiotID#TAG</span>
          <span class="profile-region" id="profileRegion">NA</span>
        </div>

        <div class="profile-line-sub" id="profileProfileName">Main Profile</div>

        <div class="profile-line-rr">
          <span class="label">Starting RR:</span>
          <span class="value" id="profileStartingRR">0</span>
        </div>
      </div>

      <div class="profile-divider"></div>

      <!-- Settings Dropdown Toggle -->
      <button class="profile-dropdown-toggle" id="profileDropdownToggle">⌄</button>

      <!-- Settings Dropdown -->
      <div id="profileDropdown" class="profile-dropdown">
        <div class="pd-section-label">Profile</div>
        <button class="pd-item" id="pdEditProfile">Edit Profile</button>
        <button class="pd-item" id="pdImportTracker">Import Tracker</button>

        <div class="pd-section-label">Settings</div>
        <button class="pd-item" id="pdOpenSettings">Open Settings</button>

        <div class="pd-section-label">Danger Zone</div>
        <button class="pd-item hazard" id="pdHardReset">Hard Reset</button>
      </div>
    </div>

    <!-- Hamburger Button (mobile) -->
    <button class="hamburger" id="hamburgerBtn">☰</button>
  </div>
</header>

<div class="app">
  <!-- HOME PAGE -->
  <section id="page-home" class="page active">
    <div class="home-layout dashboard-grid">
      <!-- Weekly Focus + Improvement Timeline -->
      <div class="card weekly-focus-card">
        <div class="card-header">
          <div>
            <div class="card-title">Weekly Focus Trend</div>
            <div class="card-sub">Where your attention actually went this week.</div>
          </div>
          <span class="card-pill">Last 7 days</span>
        </div>
        <ul class="weekly-list" id="weeklyFocusSummary" style="font-size:13px; margin:0; padding-left:18px;">
          <li>• Most practiced focus: <span class="rr-glow">Crosshair Discipline</span></li>
          <li>• Weakest self-rating: (add from logs soon)</li>
          <li>• Most tilt mentions: (add from logs soon)</li>
        </ul>

        <!-- Improvement Timeline -->
        <div class="improvement-timeline">
          <div class="timeline-header">
            <div class="timeline-title">Improvement Timeline</div>
            <div class="timeline-window">Last 5 sessions</div>
          </div>
          <div class="timeline-track" id="improvementTimeline">Last 1 games: +12 RR · 12.0 RR / game</div>
        </div>
      </div>

      <!-- Loadout Generator -->
      <div class="card loadout-card">
        <div class="card-header">
          <div>
            <div class="card-title">Loadout Generator</div>
            <div class="card-sub">Roll an agent + focus for this session.</div>
          </div>
          <span class="card-pill">Today</span>
        </div>

        <!-- Role filters -->
        <div id="roleButtons" class="role-filter-row">
          <button class="role-filter-btn active" data-role="any" id="roleAnyBtn">Any</button>
          <button class="role-filter-btn" data-role="Duelist" id="roleDuelistBtn">Duelist</button>
          <button class="role-filter-btn" data-role="Initiator" id="roleInitiatorBtn">Initiator</button>
          <button class="role-filter-btn" data-role="Controller" id="roleControllerBtn">Controller</button>
          <button class="role-filter-btn" data-role="Sentinel" id="roleSentinelBtn">Sentinel</button>
        </div>

        <div class="home-loadout-main">
          <div class="agent-frame" id="agentFrame">
            <div class="shine"></div>
            <div id="agentPlaceholder" class="agent-placeholder" style="display: none;">F</div>
          </div>
          <div class="home-loadout-info">
            <div>
              <div class="home-loadout-label">Generated Agent</div>
              <div class="home-loadout-value" id="agentName">Reyna</div>
            </div>

            <div>
              <div class="home-loadout-label">Focus</div>
              <div class="home-loadout-value" id="focusDisplay">Site Anchor Discipline</div>
            </div>
          </div>
        </div>

        <button id="spinAgentBtn" class="small-btn">Generate Loadout</button>
      </div>

      <!-- RR Calculator -->
      <div class="card rr-card">
        <div class="card-header">
          <div>
            <div class="card-title">RR Calculator</div>
            <div class="card-sub">Track this session’s RR changes quickly.</div>
          </div>
          <span class="card-pill">Session</span>
        </div>

        <div class="card-row">
          <span class="card-label">RR Δ Input</span>
          <input id="rrInput" type="number" placeholder="+/- RR" style="max-width:120px;">
        </div>

        <div class="home-rr-buttons">
          <button id="addWinBtn" class="rr-btn btn-win">Win</button>
          <button id="addLossBtn" class="rr-btn btn-loss">Loss</button>
          <button id="addDrawBtn" class="rr-btn btn-draw">Draw</button>
          <button id="undoBtn" class="rr-btn btn-undo">Undo</button>
        </div>

        <div class="rr-total">
          <span id="totalRRDisplay" data-value="0" style="color: rgb(34, 197, 94);">12</span>
        </div>

        <!-- Role-Aware Round Impact Meter -->
        <div class="impact-card">
          <div class="impact-header-row">
            <div class="timeline-title">Round Impact (Role Aware)</div>
          </div>
          <span class="impact-role-pill" id="impactRolePill">Duelist view</span>
          <div class="impact-meter">
            <div class="impact-scale">
              <span>Low impact</span>
              <span>Balanced</span>
              <span>High impact</span>
            </div>
            <div class="impact-bar-outer">
              <div class="impact-bar-fill" id="impactBarFill"></div>
              <div class="impact-marker" id="impactMarker" style="left:55%;"></div>
            </div>
          </div>
        </div>

        <div class="scoreboard">
          <div class="scorebox">
            <div class="small">Wins</div>
            <div id="winsCount" class="score-num">1</div>
          </div>
          <div class="scorebox">
            <div class="small">Losses</div>
            <div id="lossCount" class="score-num">0</div>
          </div>
          <div class="scorebox">
            <div class="small">Draws</div>
            <div id="drawCount" class="score-num">0</div>
          </div>
          <div class="scorebox">
            <div class="small">Games</div>
            <div id="totalGames" class="score-num">1</div>
          </div>
        </div>
      </div>

      <!-- RR Trend + Compass -->
      <div class="card rr-chart-card">
        <div class="card-header">
          <div class="card-title">RR Trend</div>
          <div class="card-sub">Cumulative RR across your logged matches.</div>
        </div>

        <div class="card-row">
          <button class="graph-btn active" data-size="5">5</button>
          <button class="graph-btn" data-size="20">20</button>
          <button class="graph-btn" data-size="50">50</button>
          <button class="graph-btn" data-size="all">All</button>
        </div>

        <div class="chart-compass-layout">
          <!-- RR Trend Chart -->
          <div class="home-chart-wrap compact-chart">
            <div id="chartRow">
              <svg width="710" height="220">
                <!-- Axes -->
                <line x1="40" y1="20" x2="40" y2="180" stroke="#94a3b8" stroke-width="1.5"></line>
                <line x1="40" y1="180" x2="670" y2="180" stroke="#94a3b8" stroke-width="1.5"></line>
                <path d="M40 180 L670 20 " fill="none" stroke="#38bdf8" stroke-width="2" class="chart-animate"></path>
                <circle cx="40" cy="180" r="3" fill="#e5e7eb"></circle>
                <circle cx="670" cy="20" r="3" fill="#e5e7eb"></circle>
                <circle cx="670" cy="20" class="final-end"></circle>
              </svg>
            </div>
          </div>

          <!-- Strength / Weakness Compass -->
          <div class="compass-panel">
            <div class="card-title">Strength / Weakness Compass</div>
            <div class="card-sub">Snapshot of how your stats lean this session.</div>

            <div class="compass-main">
              <div class="compass-svg-wrap">
                <svg class="sw-compass" viewBox="0 0 200 200" id="compassSvg">
                  <!-- Axes -->
                  <line x1="100" y1="10" x2="100" y2="190" class="compass-axis-line"></line>
                  <line x1="10" y1="100" x2="190" y2="100" class="compass-axis-line"></line>
                  <polygon id="compassPolygon" class="compass-polygon" points="100,40 155,100 100,160 55,100"></polygon>
                  <text x="100" y="20" text-anchor="middle" class="compass-label">Aim</text>
                  <text x="180" y="105" text-anchor="middle" class="compass-label">Gamesense</text>
                  <text x="100" y="188" text-anchor="middle" class="compass-label">Teamplay</text>
                  <text x="20" y="105" text-anchor="middle" class="compass-label">Discipline</text>
                </svg>

                <div class="compass-axis-tabs" id="compassAxisTabs">
                  <button class="compass-axis-btn active" data-lens="aim">Aim lens</button>
                  <button class="compass-axis-btn" data-lens="gamesense">Gamesense lens</button>
                  <button class="compass-axis-btn" data-lens="teamplay">Teamplay lens</button>
                  <button class="compass-axis-btn" data-lens="discipline">Discipline lens</button>
                </div>
              </div>

              <div class="compass-lens">
                <div class="lens-title" id="compassLensTitle">Aim lens — what we're using</div>
                <ul class="lens-list" id="compassLensList">
                  <li class="good">• HS% vs rank baseline (current: 27%)</li>
                  <li class="good">• Duel outcomes (FK &gt; FD)</li>
                  <li class="bad">• Aim drops in clutch &amp; eco rounds</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- end bottom RR chart + compass card -->
    </div> <!-- End of dashboard grid -->
  </section> <!-- End of Home Page -->
</div> <!-- End of app container -->
<script>
console.log("SCRIPT START");

// ========================
// GLOBAL STATE
// ========================
let profiles = [];
let activeProfileId = null;

// Per-profile session data (live in memory, persisted per profile)
let matches = [];        // [{ id, rr, result, agent, focus, map, score, notes, role, createdAt }]
let rrSum = 0;
let lastMatchesLength = 0;

let isUndoAnimating = false;
let activeRoleFilter = "any";   // for loadout generator
let currentSize = "5";          // RR chart window size

// DOM refs (filled in DOMContentLoaded)
let rrInput, addWinBtn, addLossBtn, addDrawBtn, undoBtn;
let totalRRDisplay, winsCountEl, lossCountEl, drawCountEl, totalGamesEl;
let chartRow, spinAgentBtn, agentImg, agentPlaceholder, agentName, focusDisplay;
let matchListEl;
let profileAvatarWrap, profileSwitcher, profileListEl, profilePanel;
let profileRiotIdEl, profileRegionEl, profileProfileNameEl, profileStartingRREl;
let profileDropdownToggle, profileDropdown;
let navRRProgressEl; // created in JS

// Storage keys
const STORAGE_KEY_PROFILES   = "valtracker_profiles_v1";
const STORAGE_KEY_ACTIVE_ID  = "valtracker_active_profile_id";

// Simple rank thresholds (RR total from starting point)
const RANK_THRESHOLDS = [
  { name: "Iron",       min: 0,    max: 300 },
  { name: "Bronze",     min: 300,  max: 600 },
  { name: "Silver",     min: 600,  max: 900 },
  { name: "Gold",       min: 900,  max: 1200 },
  { name: "Platinum",   min: 1200, max: 1500 },
  { name: "Diamond",    min: 1500, max: 1800 },
  { name: "Ascendant",  min: 1800, max: 2100 },
  { name: "Immortal",   min: 2100, max: 2400 },
  { name: "Radiant",    min: 2400, max: Infinity }
];

// ========================
// UTILITIES
// ========================
function safeNumber(v, fallback = 0) {
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}

function uuid() {
  return "m_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function parseScore(scoreStr) {
  if (!scoreStr) return null;
  const m = scoreStr.match(/(\d+)\s*[-:]\s*(\d+)/);
  if (!m) return null;
  return {
    my: safeNumber(m[1]),
    opp: safeNumber(m[2])
  };
}

function nowISO() {
  return new Date().toISOString();
}

// ========================
// PROFILES: LOAD / SAVE / UI
// ========================
function createDefaultProfile() {
  return {
    id: "p_default",
    name: "Main Profile",
    riotId: "RiotID#TAG",
    region: "NA",
    startingRR: 0,
    rankIconUrl: "",
    avatarUrl: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/jett.png",
    matches: []
  };
}

function loadProfiles() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_PROFILES);
    if (!raw) {
      profiles = [createDefaultProfile()];
      activeProfileId = profiles[0].id;
      saveProfiles();
      return;
    }
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      profiles = [createDefaultProfile()];
      activeProfileId = profiles[0].id;
      saveProfiles();
      return;
    }
    profiles = parsed;
  } catch (e) {
    console.warn("Failed to load profiles, resetting.", e);
    profiles = [createDefaultProfile()];
    activeProfileId = profiles[0].id;
    saveProfiles();
  }

  const storedId = localStorage.getItem(STORAGE_KEY_ACTIVE_ID);
  if (storedId && profiles.some(p => p.id === storedId)) {
    activeProfileId = storedId;
  } else {
    activeProfileId = profiles[0].id;
    localStorage.setItem(STORAGE_KEY_ACTIVE_ID, activeProfileId);
  }
}

function saveProfiles() {
  try {
    localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles));
    if (activeProfileId) {
      localStorage.setItem(STORAGE_KEY_ACTIVE_ID, activeProfileId);
    }
  } catch (e) {
    console.warn("Failed to save profiles", e);
  }
}

function getActiveProfile() {
  return profiles.find(p => p.id === activeProfileId) || profiles[0] || null;
}

function setActiveProfile(id) {
  if (activeProfileId === id) return;
  const current = getActiveProfile();
  if (current) {
    current.matches = matches.slice();
  }
  activeProfileId = id;
  localStorage.setItem(STORAGE_KEY_ACTIVE_ID, activeProfileId);
  const next = getActiveProfile();
  matches = Array.isArray(next.matches) ? next.matches.slice() : [];
  recomputeFromMatches();
  updateProfileHeaderUI();
  rebuildProfileListUI();
  updateDisplays();
  renderChart(currentSize);
  updateWeeklyFocusSummary();
  updateNavRRToRank();
  saveProfiles();
}

function handleAddProfile() {
  const name = prompt("New profile name:", "Alt Account");
  if (!name) return;

  const riotId = prompt("Riot ID (Name#TAG):", "RiotID#TAG") || "RiotID#TAG";
  const region = prompt("Region (e.g. NA, EU):", "NA") || "NA";

  const newProfile = {
    id: "p_" + Date.now(),
    name,
    riotId,
    region,
    startingRR: 0,
    rankIconUrl: "",
    avatarUrl: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/jett.png",
    matches: []
  };
  profiles.push(newProfile);
  saveProfiles();
  setActiveProfile(newProfile.id);
}

function updateProfileHeaderUI() {
  const p = getActiveProfile();
  if (!p) return;

  if (profileRiotIdEl)    profileRiotIdEl.textContent    = p.riotId || "RiotID#TAG";
  if (profileRegionEl)    profileRegionEl.textContent    = p.region || "NA";
  if (profileProfileNameEl) profileProfileNameEl.textContent = p.name || "Profile";
  if (profileStartingRREl)  profileStartingRREl.textContent  = safeNumber(p.startingRR, 0);

  const avatarImg = document.getElementById("profileAvatarImg");
  if (avatarImg && p.avatarUrl) {
    avatarImg.src = p.avatarUrl;
  }

  const rankIconEl = document.getElementById("profileRankIcon");
  if (rankIconEl) {
    if (p.rankIconUrl) {
      rankIconEl.src = p.rankIconUrl;
      rankIconEl.style.display = "block";
    } else {
      rankIconEl.style.display = "none";
    }
  }

  updateNavRRToRank();
}

function rebuildProfileListUI() {
  if (!profileListEl) return;
  profileListEl.innerHTML = "";
  profiles.forEach(p => {
    const btn = document.createElement("button");
    btn.className = "profile-switcher-item" + (p.id === activeProfileId ? " active" : "");
    btn.dataset.profileId = p.id;
    btn.innerHTML = `
      <span style="font-weight:600;">${p.name || "Profile"}</span>
      <span style="font-size:11px; color:#94a3b8;">${p.riotId || "RiotID#TAG"} · ${p.region || "NA"}</span>
    `;
    btn.addEventListener("click", () => {
      setActiveProfile(p.id);
      toggleProfileSwitcher(true);
    });
    profileListEl.appendChild(btn);
  });
}

// ========================
// NAV: PAGE SWITCHING + UNDERLINE
// ========================
function updateNavUnderline() {
  const activeBtn = document.querySelector(".nav-btn.active");
  const underline = document.querySelector(".nav-underline");
  const container = document.querySelector(".nav-links");
  if (!activeBtn || !underline || !container) return;

  const rect = activeBtn.getBoundingClientRect();
  const parentRect = container.getBoundingClientRect();
  underline.style.width = rect.width + "px";
  underline.style.left = (rect.left - parentRect.left) + "px";
}

function activatePage(pageId) {
  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.page === pageId);
  });
  document.querySelectorAll(".page").forEach(page => {
    page.classList.toggle("active", page.id === "page-" + pageId);
  });
  updateNavUnderline();
}

// ========================
// PROFILE SWITCHER + SETTINGS DROPDOWN
// ========================
function toggleProfileSwitcher(forceClose) {
  if (!profileSwitcher || !profileAvatarWrap) return;
  const isOpen = profileSwitcher.classList.contains("open");
  if (forceClose) {
    profileSwitcher.classList.remove("open");
    profileAvatarWrap.classList.remove("selected");
    return;
  }
  if (isOpen) {
    profileSwitcher.classList.remove("open");
    profileAvatarWrap.classList.remove("selected");
  } else {
    profileSwitcher.classList.add("open");
    profileAvatarWrap.classList.add("selected");
  }
}

function toggleProfileDropdown(forceClose) {
  if (!profileDropdown || !profilePanel) return;
  const isOpen = profileDropdown.classList.contains("open");
  if (forceClose) {
    profileDropdown.classList.remove("open");
    profilePanel.classList.remove("open");
    return;
  }
  if (isOpen) {
    profileDropdown.classList.remove("open");
    profilePanel.classList.remove("open");
  } else {
    profileDropdown.classList.add("open");
    profilePanel.classList.add("open");
  }
}

// ========================
// MATCHES + RR STATS
// ========================
function recomputeFromMatches() {
  rrSum = 0;
  let w = 0, l = 0, d = 0;

  matches.forEach(m => {
    rrSum += safeNumber(m.rr);
    if (m.result === "win")  w++;
    else if (m.result === "loss") l++;
    else if (m.result === "draw") d++;
  });

  lastMatchesLength = matches.length;

  if (winsCountEl)   winsCountEl.textContent = w;
  if (lossCountEl)   lossCountEl.textContent = l;
  if (drawCountEl)   drawCountEl.textContent = d;
  if (totalGamesEl)  totalGamesEl.textContent = matches.length;
  if (totalRRDisplay) totalRRDisplay.textContent = rrSum;

  // Save back to profile
  const p = getActiveProfile();
  if (p) {
    p.matches = matches.slice();
    saveProfiles();
  }

  updateNavRRToRank();
}

function addRRChange(delta, meta = {}) {
  const rr = safeNumber(delta);
  const result = meta.result || (rr > 0 ? "win" : rr < 0 ? "loss" : "draw");
  const newMatch = {
    id: uuid(),
    rr,
    result,
    agent: meta.agent || (agentName ? agentName.textContent : ""),
    focus: meta.focus || (focusDisplay ? focusDisplay.textContent : ""),
    map: meta.map || "",
    score: meta.score || "",
    notes: meta.notes || "",
    role: meta.role || activeRoleFilter || "any",
    createdAt: nowISO()
  };

  matches.push(newMatch);
  recomputeFromMatches();
  updateDisplays();

  // Chart: animate only the new segment
  renderChart(currentSize);

  // Weekly focus + advanced views
  updateWeeklyFocusSummary();
  updateImprovementTimeline();
  updateRoleImpactMeter();
  updateStrengthCompass();
}

function undoLastMatch() {
  if (!matches.length) return;
  isUndoAnimating = true;

  matches.pop();
  recomputeFromMatches();
  updateDisplays();
  renderChart(currentSize);
  updateWeeklyFocusSummary();
  updateImprovementTimeline();
  updateRoleImpactMeter();
  updateStrengthCompass();

  setTimeout(() => { isUndoAnimating = false; }, 400);
}

console.log("BOTTOM OF FILE REACHED");
</script>
</body>
</html>
