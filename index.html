<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valorant Randomizer & Tracker</title>
  <style>
    :root {
      --bg: #071029;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #ff4655;
      --good: #16a34a;
      --bad: #ef4444;
      --seg-bg: #0f1724;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--bg), #071b2b);
      color: #e6eef8;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 18px;
      display: flex;
      justify-content: center;
    }
    .app { width: 100%; max-width: 980px; }
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .logo {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
    }
    h1 { margin: 0; font-size: 18px; }
    .sub { color: var(--muted); font-size: 13px; }
    .layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 14px;
    }
    @media (max-width: 920px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(2, 6, 23, 0.6);
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .label { color: var(--muted); font-size: 12px; }
    .big { font-size: 22px; font-weight: 700; }
    button {
      background: var(--accent);
      border: 0;
      padding: 8px 12px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    button.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .btn-win { background: var(--good); }
    .btn-loss { background: var(--bad); }
    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: transparent;
      color: inherit;
    }
    textarea { min-height: 64px; resize: vertical; }
    .agent-icon {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      padding: 6px;
    }
    .focus-text {
      transition: opacity 0.28s ease, transform 0.28s ease;
    }
    .focus-text.hidden {
      opacity: 0;
      transform: translateY(-6px);
    }
    .agent-frame {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .agent-frame .shine {
      position: absolute;
      inset: 0;
      border-radius: 12px;
      pointer-events: none;
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.02),
        rgba(255, 255, 255, 0.06) 40%,
        rgba(255, 255, 255, 0.02)
      );
      mix-blend-mode: overlay;
      opacity: 0;
    }
    .agent-frame.spin .shine {
      animation: shine 0.7s linear;
    }
    @keyframes shine {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
    .rating-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .rating-labels {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--muted);
    }
    .rating-bar {
      width: 100%;
      height: 34px;
      background: var(--seg-bg);
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 6px;
      box-sizing: border-box;
      position: relative;
    }
    .rating-center {
      position: absolute;
      left: 50%;
      top: 6px;
      bottom: 6px;
      width: 2px;
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(-50%);
    }
    .segments {
      display: flex;
      gap: 6px;
      width: 100%;
      height: 100%;
    }
    .seg {
      flex: 1;
      height: 100%;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.02);
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .seg.win {
      background: linear-gradient(180deg, var(--good), #0b6b37);
      transform: scaleY(1.03);
    }
    .seg.loss {
      background: linear-gradient(180deg, #b91c1c, var(--bad));
      transform: scaleY(1.03);
    }
    .scoreboard {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
    }
    .scorebox {
      background: rgba(255, 255, 255, 0.02);
      padding: 8px 10px;
      border-radius: 8px;
      text-align: center;
    }
    .score-num {
      font-weight: 700;
      font-size: 18px;
    }
    .muted { color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    ul {
      list-style: none;
      padding: 0;
      margin: 8px 0;
      max-height: 160px;
      overflow: auto;
    }
    li {
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.02);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      height: 120px;
      padding: 8px;
      overflow-x: auto;
    }
    .chart-bar {
      width: 18px;
      border-radius: 4px;
      display: inline-block;
      transition: height 0.36s;
    }
    .pop {
      animation: popAnim 0.34s cubic-bezier(0.2, 0.9, 0.3, 1);
    }
    @keyframes popAnim {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img
        class="logo"
        src="https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/val-logo.png"
        alt="Valorant Logo"
      />
      <div>
        <h1>Valorant Randomizer & Tracker</h1>
        <div class="sub">
          Agent slot • Focus fade • RR + Match tracker • Logs • CSV export
        </div>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT SIDE -->
      <div>
        <!-- Agent / Focus -->
        <div class="card">
          <div class="row" style="justify-content: space-between; align-items: center">
            <div class="agent-frame" id="agentFrame">
              <div class="label">Agent</div>
              <!-- Transparent placeholder to avoid broken image icon before first spin -->
              <img
                id="agentImg"
                class="agent-icon"
                src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                alt="agent"
              />
              <div id="agentName" class="muted small"></div>
              <div class="shine"></div>
            </div>

            <div
              style="
                width: 2px;
                background: rgba(255, 255, 255, 0.06);
                height: 86px;
                border-radius: 2px;
                margin: 0 12px;
              "
            ></div>

            <div class="center" style="min-width: 180px">
              <div class="label">Focus</div>
              <div id="focusDisplay" class="big focus-text">-</div>
              <div class="small muted">Short labels used</div>
            </div>
          </div>
		  <div class="row" style="margin-top: 12px; justify-content: center">
            <button id="spinAgentBtn">Spin Agent</button>
            <button id="spinFocusBtn" style="background: #7c3aed">Spin Focus</button>
            <button id="resetBtn" class="ghost">Full Reset</button>
          </div>
        </div>

        <!-- RR + scoreboard + chart -->
        <div class="card" style="margin-top: 12px">
          <h3 style="margin: 0 0 8px">RR Calculator</h3>
          <div class="row" style="align-items: center">
            <input id="rrInput" type="number" placeholder="Enter RR (e.g. 12)" value="0" />
            <div style="display: flex; gap: 8px; flex-wrap: wrap">
              <button id="addWinBtn" class="btn-win">Add Win</button>
              <button id="addLossBtn" class="btn-loss">Add Loss</button>
              <button id="undoBtn" class="ghost">Undo</button>
            </div>
          </div>

          <div style="margin-top: 12px" class="row">
            <div style="flex: 1">
              <div class="label">Wins (tap to remove)</div>
              <ul id="winsList"></ul>
            </div>
            <div style="flex: 1">
              <div class="label">Losses (tap to remove)</div>
              <ul id="lossesList"></ul>
            </div>
          </div>

          <div style="margin-top: 12px" class="rating-wrap">
            <div class="rating-labels">
              <div>Loss</div>
              <div>Gain</div>
            </div>
            <div class="rating-bar">
              <div class="rating-center"></div>
              <div class="segments" id="segmentsContainer"></div>
            </div>
            <div class="scoreboard">
              <div class="scorebox">
                <div class="small">Wins</div>
                <div id="winsCount" class="score-num">0</div>
              </div>
              <div class="scorebox">
                <div class="small">Losses</div>
                <div id="lossCount" class="score-num">0</div>
              </div>
              <div class="scorebox">
                <div class="small">Total Games</div>
                <div id="totalGames" class="score-num">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 12px">
          <h4 style="margin: 0 0 8px">RR over recent matches (latest 20)</h4>
          <div id="chartRow" class="chart-row"></div>
          <div
            style="
              margin-top: 8px;
              display: flex;
              gap: 8px;
              align-items: center;
              justify-content: center;
            "
          >
            <div class="small muted">Negative</div>
            <div style="width: 16px; height: 10px; background: #ef4444; border-radius: 2px"></div>
            <div class="small muted">Positive</div>
            <div style="width: 16px; height: 10px; background: #16a34a; border-radius: 2px"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE: Match tracker + logs -->
      <div>
        <div class="card">
          <h3 style="margin: 0 0 8px">Match Tracker</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
            <select id="matchAgent"><option value="">Agent (optional)</option></select>
            <select id="matchFocus"><option value="">Focus (optional)</option></select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px">
            <select id="matchResult">
              <option value="win">Win</option>
              <option value="loss">Loss</option>
            </select>
            <input id="matchRR" type="number" placeholder="RR change (e.g. 15)" />
          </div>
          <input id="matchMap" type="text" placeholder="Map (optional)" style="margin-top: 8px" />
          <input
            id="matchScore"
            type="text"
            placeholder="Score (optional) e.g. 13-10"
            style="margin-top: 8px"
          />
          <textarea id="matchNotes" placeholder="Notes (key moments)" style="margin-top: 8px"></textarea>
          <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap">
            <button id="addMatchBtn">Add Match</button>
            <button id="exportCsvBtn" class="ghost">Export Combined CSV</button>
            <button id="clearMatchesBtn" class="ghost">Clear Matches</button>
          </div>

          <div style="margin-top: 10px">
            <div class="label">Recent Matches</div>
            <ul id="matchesList"></ul>
          </div>
        </div>

        <div class="card" style="margin-top: 12px">
          <h3 style="margin: 0 0 8px">Performance Log</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
            <select id="logAgent"><option value="">Agent</option></select>
            <select id="logFocus"><option value="">Focus</option></select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px">
            <input id="logRating" type="number" min="1" max="5" placeholder="Self rating 1-5" />
            <input id="logMood" type="text" placeholder="Mental state (focused/tilt)" />
          </div>
          <textarea
            id="logNotes"
            placeholder="What went well / what to work on"
            style="margin-top: 8px"
          ></textarea>
          <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap">
            <button id="addLogBtn">Save Log</button>
            <button id="clearLogsBtn" class="ghost">Clear Logs</button>
          </div>

          <div style="margin-top: 10px">
            <div class="label">Recent Logs</div>
            <ul id="logsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const agentIcons = {
      astra: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/astra.png",
      breach: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/breach.png",
      brimstone: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/brimstone.png",
      chamber: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/chamber.png",
      clove: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/clove.png",
      cypher: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/cypher.png",
      deadlock: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/deadlock.png",
      fade: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/fade.png",
      gekko: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/gekko.png",
      harbor: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/harbor.png",
      iso: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/iso.png",
      jett: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/jett.png",
      kayo: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/kayo.png",
      killjoy: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/killjoy.png",
      neon: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/neon.png",
      omen: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/omen.png",
      phoenix: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/phoenix.png",
      raze: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/raze.png",
      reyna: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/reyna.png",
      sage: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/sage.png",
      skye: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/skye.png",
      sova: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/sova.png",
      tejo: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/tejo.png",
      veto: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/veto.png",
      viper: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/viper.png",
      vyse: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/vyse.png",
      waylay: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/waylay.png",
      yoru: "https://raw.githubusercontent.com/michealdoolittle-cyber/images/main/icons/yoru.png"
    };

    const agents = Object.keys(agentIcons);
    const focuses = [
      "CH Placement",
      "Peak Timing",
      "FB Accuracy",
      "Trading",
      "Rotations",
      "Utility Timing",
      "Jiggle Timing",
      "Entry Pathing"
    ];

    const agentImg = document.getElementById("agentImg");
    const agentName = document.getElementById("agentName");
    const agentFrame = document.getElementById("agentFrame");
    const focusDisplay = document.getElementById("focusDisplay");
    const spinAgentBtn = document.getElementById("spinAgentBtn");
    const spinFocusBtn = document.getElementById("spinFocusBtn");
    const resetBtn = document.getElementById("resetBtn");

    const rrInput = document.getElementById("rrInput");
    const addWinBtn = document.getElementById("addWinBtn");
    const addLossBtn = document.getElementById("addLossBtn");
    const undoBtn = document.getElementById("undoBtn");
    const winsList = document.getElementById("winsList");
    const lossesList = document.getElementById("lossesList");

    const winsCountEl = document.getElementById("winsCount");
    const lossCountEl = document.getElementById("lossCount");
    const totalGamesEl = document.getElementById("totalGames");
    const segmentsContainer = document.getElementById("segmentsContainer");
    const chartRow = document.getElementById("chartRow");

    const matchAgent = document.getElementById("matchAgent");
    const matchFocus = document.getElementById("matchFocus");
    const matchResult = document.getElementById("matchResult");
    const matchRR = document.getElementById("matchRR");
    const matchMap = document.getElementById("matchMap");
    const matchScore = document.getElementById("matchScore");
    const matchNotes = document.getElementById("matchNotes");
    const addMatchBtn = document.getElementById("addMatchBtn");
    const clearMatchesBtn = document.getElementById("clearMatchesBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const matchesList = document.getElementById("matchesList");

    const logAgent = document.getElementById("logAgent");
    const logFocus = document.getElementById("logFocus");
    const logRating = document.getElementById("logRating");
    const logMood = document.getElementById("logMood");
    const logNotes = document.getElementById("logNotes");
    const addLogBtn = document.getElementById("addLogBtn");
    const clearLogsBtn = document.getElementById("clearLogsBtn");
    const logsList = document.getElementById("logsList");

    let wins = [];
    let losses = [];
    let history = [];
    let matches = [];
    let logs = [];
    let winsCount = 0;
    let lossCount = 0;
    const SEGMENTS = 20;

    function titleCase(s) {
      return s.replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function saveAll() {
      localStorage.setItem("vr_wins", JSON.stringify(wins));
      localStorage.setItem("vr_losses", JSON.stringify(losses));
      localStorage.setItem("vr_matches", JSON.stringify(matches));
      localStorage.setItem("vr_logs", JSON.stringify(logs));
      localStorage.setItem("vr_counts", JSON.stringify({ winsCount, lossCount }));
    }

    function loadAll() {
      wins = JSON.parse(localStorage.getItem("vr_wins") || "[]");
      losses = JSON.parse(localStorage.getItem("vr_losses") || "[]");
      matches = JSON.parse(localStorage.getItem("vr_matches") || "[]");
      logs = JSON.parse(localStorage.getItem("vr_logs") || "[]");
      const c = JSON.parse(localStorage.getItem("vr_counts") || '{"winsCount":0,"lossCount":0}');
      winsCount = c.winsCount || 0;
      lossCount = c.lossCount || 0;
    }

    function populateSelects() {
      [matchAgent, logAgent].forEach((sel) => {
        sel.innerHTML = '<option value="">Agent</option>';
        agents.forEach((a) =>
          sel.insertAdjacentHTML("beforeend", `<option value="${a}">${titleCase(a)}</option>`)
        );
      });
      [matchFocus, logFocus].forEach((sel) => {
        sel.innerHTML = '<option value="">Focus</option>';
        focuses.forEach((f) =>
          sel.insertAdjacentHTML("beforeend", `<option value="${f}">${f}</option>`)
        );
      });
    }

    function createSegments() {
      segmentsContainer.innerHTML = "";
      for (let i = 0; i < SEGMENTS; i++) {
        const d = document.createElement("div");
        d.className = "seg";
        segmentsContainer.appendChild(d);
      }
    }

    function updateScoreboard() {
      winsCountEl.textContent = winsCount;
      lossCountEl.textContent = lossCount;
      totalGamesEl.textContent = winsCount + lossCount;
      [winsCountEl, lossCountEl, totalGamesEl].forEach((el) => {
        el.classList.add("pop");
        setTimeout(() => el.classList.remove("pop"), 340);
      });
    }

    function renderChart() {
      chartRow.innerHTML = "";
      const recent = matches.slice(-20);
      if (recent.length === 0) {
        chartRow.innerHTML = '<div class="small muted">No matches yet</div>';
        return;
      }
      let maxAbs = Math.max(...recent.map((m) => Math.abs(Number(m.rr) || 0)), 1);
      recent.forEach((m) => {
        const bar = document.createElement("div");
        bar.className = "chart-bar";
        const h = Math.max(6, Math.round((Math.abs(m.rr) / maxAbs) * 110));
        bar.style.height = h + "px";
        bar.title = `${m.result.toUpperCase()} ${m.rr} ${m.agent || ""} ${m.focus || ""}`;
        if (m.rr > 0) {
          bar.style.background = "linear-gradient(180deg,#16a34a,#064e3b)";
        } else {
          bar.style.background = "linear-gradient(180deg,#ef4444,#7f1d1d)";
        }
        chartRow.appendChild(bar);
      });
    }
	function updateRating() {
      const sumWins = wins.reduce((a, b) => a + b, 0);
      const sumLosses = losses.reduce((a, b) => a + b, 0);
      const total = sumWins + sumLosses;
      const MIN = -50, MAX = 50;
      const clamped = Math.max(MIN, Math.min(MAX, total));
      const ratio = (clamped - MIN) / (MAX - MIN);
      const filled = Math.round(ratio * SEGMENTS);
      const segs = Array.from(segmentsContainer.children);
      segs.forEach((s, idx) => {
        s.classList.remove("win", "loss");
        if (idx < filled) {
          const centerIndex = SEGMENTS / 2;
          if (idx >= centerIndex) s.classList.add("win");
          else s.classList.add("loss");
        }
      });
      renderChart();
    }

    function renderLists() {
      winsList.innerHTML = "";
      lossesList.innerHTML = "";
      wins.forEach((v, i) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${v}</span><div><button class="ghost">remove</button></div>`;
        li.querySelector("button").addEventListener("click", () => {
          history.push({ type: "remove-win", index: i, value: v });
          wins.splice(i, 1);
          winsCount = Math.max(0, winsCount - 1);
          updateDisplays();
        });
        winsList.appendChild(li);
      });
      losses.forEach((v, i) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${v}</span><div><button class="ghost">remove</button></div>`;
        li.querySelector("button").addEventListener("click", () => {
          history.push({ type: "remove-loss", index: i, value: v });
          losses.splice(i, 1);
          lossCount = Math.max(0, lossCount - 1);
          updateDisplays();
        });
        lossesList.appendChild(li);
      });
    }

    function renderMatches() {
      matchesList.innerHTML = "";
      if (matches.length === 0) {
        matchesList.innerHTML = '<li class="small muted">No matches yet</li>';
        return;
      }
      matches.slice().reverse().forEach((m, idxRev) => {
        const idx = matches.length - 1 - idxRev;
        const li = document.createElement("li");
        li.innerHTML = `
          <div style="text-align:left">
            <strong>${m.result.toUpperCase()}</strong> ${
              m.rr > 0 ? "+" + m.rr : m.rr
            }
            <div class="small muted">
              ${m.agent || ""} ${m.focus ? "• " + m.focus : ""} 
              ${m.map ? "• " + m.map : ""} ${m.score ? "• " + m.score : ""}
              ${m.dateDisplay || ""}
            </div>
            <div class="small">${m.notes || ""}</div>
          </div>
          <div><button class="ghost">remove</button></div>
        `;
        li.querySelector("button").addEventListener("click", () => {
          const removed = matches.splice(idx, 1)[0];
          if (Number(removed.rr) > 0) {
            const winIdx = wins.indexOf(Number(removed.rr));
            if (winIdx >= 0) wins.splice(winIdx, 1);
            winsCount = Math.max(0, winsCount - 1);
          } else {
            const lossIdx = losses.indexOf(Number(removed.rr));
            if (lossIdx >= 0) losses.splice(lossIdx, 1);
            lossCount = Math.max(0, lossCount - 1);
          }
          updateDisplays();
        });
        matchesList.appendChild(li);
      });
    }

    function renderLogs() {
      logsList.innerHTML = "";
      if (logs.length === 0) {
        logsList.innerHTML = '<li class="small muted">No logs yet</li>';
        return;
      }
      logs.slice().reverse().forEach((l, idxRev) => {
        const idx = logs.length - 1 - idxRev;
        const li = document.createElement("li");
        li.innerHTML = `
          <div style="text-align:left">
            <strong>${l.agent || ""} ${l.focus ? "• " + l.focus : ""}</strong>
            <div class="small muted">
              Rating: ${l.rating || ""} • ${l.mood || ""} • ${l.dateDisplay || ""}
            </div>
            <div class="small">${l.notes || ""}</div>
          </div>
          <div><button class="ghost">remove</button></div>
        `;
        li.querySelector("button").addEventListener("click", () => {
          logs.splice(idx, 1);
          saveAll();
          renderLogs();
        });
        logsList.appendChild(li);
      });
    }

    function updateDisplays() {
      renderLists();
      renderMatches();
      renderLogs();
      updateScoreboard();
      updateRating();
      saveAll();
    }

    let lastAgent = null;
    function spinAgentSlot(duration = 1200) {
      agentFrame.classList.add("spin");
      const steps = 24;
      const seq = [];
      for (let i = 0; i < steps - 1; i++) {
        seq.push(agents[Math.floor(Math.random() * agents.length)]);
      }
      let final;
      do {
        final = agents[Math.floor(Math.random() * agents.length)];
      } while (final === lastAgent);
      seq.push(final);
      seq.forEach((name, idx) => {
        const t = Math.round((duration / steps) * (idx + 1) + idx * 6);
        setTimeout(() => {
          agentImg.src = agentIcons[name];
          agentName.textContent = titleCase(name);
          if (idx === seq.length - 1) {
            lastAgent = name;
            agentImg.classList.add("pop");
            setTimeout(() => agentImg.classList.remove("pop"), 360);
            agentFrame.classList.remove("spin");
          }
        }, t);
      });
    }

    let lastFocus = null;
    function spinFocus() {
      let pick;
      do {
        pick = focuses[Math.floor(Math.random() * focuses.length)];
      } while (pick === lastFocus);
      lastFocus = pick;
      focusDisplay.classList.add("hidden");
      setTimeout(() => {
        focusDisplay.textContent = titleCase(pick);
        focusDisplay.classList.remove("hidden");
        focusDisplay.classList.add("pop");
        setTimeout(() => focusDisplay.classList.remove("pop"), 360);
      }, 260);
    }

    addWinBtn.addEventListener("click", () => {
      const v = Number(rrInput.value) || 0;
      wins.push(v);
      history.push({ type: "add-win", value: v });
      winsCount++;
      rrInput.value = "";
      updateDisplays();
    });

    addLossBtn.addEventListener("click", () => {
      const v = Number(rrInput.value) || 0;
      const neg = -Math.abs(v);
      losses.push(neg);
      history.push({ type: "add-loss", value: neg });
      lossCount++;
      rrInput.value = "";
      updateDisplays();
    });

    undoBtn.addEventListener("click", () => {
      const last = history.pop();
      if (!last) {
        alert("Nothing to undo");
        return;
      }
      if (last.type === "add-win") {
        wins.pop();
        winsCount = Math.max(0, winsCount - 1);
      } else if (last.type === "add-loss") {
        losses.pop();
        lossCount = Math.max(0, lossCount - 1);
      } else if (last.type === "remove-win") {
        wins.splice(last.index, 0, last.value);
        winsCount++;
      } else if (last.type === "remove-loss") {
        losses.splice(last.index, 0, last.value);
        lossCount++;
      }
      updateDisplays();
    });

    function formatDateMMDDYYYY(isoString) {
      const d = new Date(isoString);
      if (isNaN(d)) {
        const now = new Date();
        return (
          String(now.getMonth() + 1).padStart(2, "0") +
          "/" +
          String(now.getDate()).padStart(2, "0") +
          "/" +
          now.getFullYear()
        );
      }
      return (
        String(d.getMonth() + 1).padStart(2, "0") +
        "/" +
        String(d.getDate()).padStart(2, "0") +
        "/" +
        d.getFullYear()
      );
    }

    addMatchBtn.addEventListener("click", () => {
      const agent = matchAgent.value || "";
      const focus = matchFocus.value || "";
      const result = matchResult.value;
      const rrVal = Number(matchRR.value) || 0;
      const map = matchMap.value || "";
      const score = matchScore.value || "";
      const notes = matchNotes.value || "";
      const iso = new Date().toISOString();
      const entry = {
        agent,
        focus,
        result,
        rr: result === "win" ? rrVal : -Math.abs(rrVal),
       map,
        score,
        notes,
        date: iso,
        dateDisplay: formatDateMMDDYYYY(iso)
      };
      matches.push(entry);
      if (entry.rr > 0) {
        wins.push(entry.rr);
        winsCount++;
        history.push({ type: "add-win", value: entry.rr });
      } else {
        losses.push(entry.rr);
        lossCount++;
        history.push({ type: "add-loss", value: entry.rr });
      }
      matchAgent.value = "";
      matchFocus.value = "";
      matchRR.value = "";
      matchMap.value = "";
      matchScore.value = "";
      matchNotes.value = "";
      updateDisplays();
    });

    clearMatchesBtn.addEventListener("click", () => {
      if (!confirm("Clear all matches?")) return;
      matches = [];
      updateDisplays();
    });

    addLogBtn.addEventListener("click", () => {
      const iso = new Date().toISOString();
      const entry = {
        agent: logAgent.value || "",
        focus: logFocus.value || "",
        rating: Number(logRating.value) || "",
        mood: logMood.value || "",
        notes: logNotes.value || "",
        date: iso,
        dateDisplay: formatDateMMDDYYYY(iso)
      };
      logs.push(entry);
      logAgent.value = "";
      logFocus.value = "";
      logRating.value = "";
      logMood.value = "";
      logNotes.value = "";
      saveAll();
      renderLogs();
    });

    clearLogsBtn.addEventListener("click", () => {
      if (!confirm("Clear all logs?")) return;
      logs = [];
      saveAll();
      renderLogs();
    });
	function downloadCSV(filename, csvString) {
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    exportCsvBtn.addEventListener("click", () => {
      const headers = [
        "Date",
        "Type",
        "Agent",
        "Focus",
        "Result",
        "RR",
        "Map",
        "Score",
        "Self-Rating",
        "Mental State",
        "Notes"
      ];
      const items = [];
      matches.forEach((m) => {
        let ts = Date.parse(m.date);
        if (isNaN(ts)) ts = Date.now();
        items.push({
          ts,
          type: "match",
          dateISO: m.date,
          agent: m.agent || "",
          focus: m.focus || "",
          result: m.result || "",
          rr: m.rr || "",
          map: m.map || "",
          score: m.score || "",
          rating: "",
          mood: "",
          notes: m.notes || ""
        });
      });
      logs.forEach((l) => {
        let ts = Date.parse(l.date);
        if (isNaN(ts)) ts = Date.now();
        items.push({
          ts,
          type: "log",
          dateISO: l.date,
          agent: l.agent || "",
          focus: l.focus || "",
          result: "",
          rr: "",
          map: "",
          score: "",
          rating: l.rating || "",
          mood: l.mood || "",
          notes: l.notes || ""
        });
      });
      items.sort((a, b) => a.ts - b.ts);
      const rows = [headers.join(",")];
      items.forEach((it) => {
        const date = formatDateMMDDYYYY(it.dateISO || new Date(it.ts).toISOString());
        const row = [
          `"${date}"`,
          `"${it.type}"`,
          `"${(it.agent || "").replace(/"/g, '""')}"`,
          `"${(it.focus || "").replace(/"/g, '""')}"`,
          `"${(it.result || "").replace(/"/g, '""')}"`,
          `"${String(it.rr || "")}"`,
          `"${(it.map || "").replace(/"/g, '""')}"`,
          `"${(it.score || "").replace(/"/g, '""')}"`,
          `"${String(it.rating || "")}"`,
          `"${(it.mood || "").replace(/"/g, '""')}"`,
          `"${(it.notes || "").replace(/"/g, '""')}"`
        ];
        rows.push(row.join(","));
      });
      const csv = rows.join("\n");
      downloadCSV("valorant_tracker_export.csv", csv);
    });

    resetBtn.addEventListener("click", () => {
      if (!confirm("Reset EVERYTHING (matches, logs, RR, scoreboard)?")) return;
      wins = [];
      losses = [];
      history = [];
      matches = [];
      logs = [];
      winsCount = 0;
      lossCount = 0;
      agentImg.src =
        "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
      agentName.textContent = "";
      focusDisplay.textContent = "-";
      saveAll();
      createSegments();
      updateDisplays();
    });

    spinAgentBtn.addEventListener("click", () => spinAgentSlot(1200));
    spinFocusBtn.addEventListener("click", spinFocus);

    loadAll();
    createSegments();
    populateSelects();
    renderLists();
    renderMatches();
    renderLogs();
    updateScoreboard();
    updateRating();
    renderChart();
  </script>
</body>
</html>